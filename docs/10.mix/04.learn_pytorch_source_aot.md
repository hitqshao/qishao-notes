---
title: Understanding Pytorch Source Code AOT
date: 2024-12-15 15:32:49
permalink: /pages/f00003/
---

# AOT
## aot dispatch

### aot_dispatch_autograd_graph



* pytree.tree_map: This function processes the traced_tangents to ensure they are detached and contiguous if they are tensors, preparing them for tracing.
* fn_prepped_for_autograd: Prepares the original function for autograd by incorporating metadata about views and mutations, ensuring correct handling of these aspects during tracing.
* ***create_joint***: Creates a joint forward-backward function that traces both the forward and backward passes together, enabling efficient autograd processing.
* create_functionalized_fn: Converts the joint function into a functional form, handling input mutations and tracing the joint structure, ensuring compatibility with autograd.
* aot_dispatch_subclass: Handles tracing for tensor subclasses, ensuring that the autograd process can correctly handle these specialized tensor types.
* ***_create_graph***: Creates an FX graph from the joint function and its inputs, providing a lower-level representation of the function for optimization and execution.
* ***fx_g.graph.eliminate_dead_code***: Eliminates any dead code from the FX graph to optimize it, improving performance and reducing unnecessary computations.
* ***fx_g.recompile***: Recompiles the FX graph after eliminating dead code, ensuring that the graph is up-to-date and optimized for execution.

<details>
  <summary>Code</summary>

```python
    ### dispatch_and_compile_graph.py
    fn_prepared_for_autograd = fn_prepped_for_autograd(
        flat_fn,
        fw_metadata,
    )
    joint_fn_to_trace = create_joint(fn_prepared_for_autograd, aot_config=aot_config)

    joint_fn_to_trace, updated_joint_inputs = create_functionalized_fn(
        joint_fn_to_trace,
        joint_inputs,
        meta=fw_metadata,
        aot_config=aot_config,
        trace_joint=True,
    )

    subclass_tracing_info = aot_dispatch_subclass(
        joint_fn_to_trace,
        updated_joint_inputs,
        is_joint_structure=True,
        meta=fw_metadata,
        fw_only=flat_fn,
    )
    ...
    fx_g = _create_graph(joint_fn_to_trace, updated_joint_inputs, aot_config=aot_config)
    ...
    fx_g.graph.eliminate_dead_code()
    fx_g.recompile()
```
</details>
