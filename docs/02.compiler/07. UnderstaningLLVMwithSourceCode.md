---
title: Understand llvm with its source code
output:
  html_document:
    code_folding: hide
date: 2024-07-05
permalink: /pages/000007/
---

![image](https://github.com/hitqshao/qishao-notes/assets/23403286/5e0d9f07-3743-474c-94f4-264c8f1fab8c)

### 1. Create SelectionDAG

SelectionDAG Builder calls visit() function to build SDNode
```cpp
// CodeGen/SelectionDAG/SelectionDAGBuilder.cpp
void SelectionDAGBuilder::visit(unsigned Opcode, const User &I) {
  // Note: this doesn't use InstVisitor, because it has to work with
  // ConstantExpr's in addition to instructions.
  switch (Opcode) {
  default: llvm_unreachable("Unknown instruction type encountered!");
    // Build the switch statement using the Instruction.def file.
#define HANDLE_INST(NUM, OPCODE, CLASS) \
    case Instruction::OPCODE: visit##OPCODE((const CLASS&)I); break;
#include "llvm/IR/Instruction.def"
  }
}

// include/llvm/IR/Instruction.def
HANDLE_BINARY_INST(20, SDiv , BinaryOperator)
```
visitSDiv(const User &I) will create SDValue as operand and SDNode for each IR
```cpp
void SelectionDAGBuilder::visitSDiv(const User &I) {
  SDValue Op1 = getValue(I.getOperand(0));
  SDValue Op2 = getValue(I.getOperand(1));

  SDNodeFlags Flags;
  Flags.setExact(isa<PossiblyExactOperator>(&I) &&
                 cast<PossiblyExactOperator>(&I)->isExact());
  setValue(&I, DAG.getNode(ISD::SDIV, getCurSDLoc(), Op1.getValueType(), Op1,
                           Op2, Flags));
}
```

SDNode also contains dependencies in SDValue, SDValue include following:
1. data dependency
2. chain dependency. For example. order load, store insturction to the same address
3. glue of instructions.

### 2. Legalization
Legalization will legalize SDNode operation that is  unsupported target into supported Node.
It includes legalization of operation and operand.
As to operation, it includes 3 major operation:
1. Expansion expand one op into series of op
2. Promotion promote data type
3. Custom

```cpp
/// Return a legal replacement for the given operation, with all legal operands.
void SelectionDAGLegalize::LegalizeOp(SDNode *Node) {
.....
    case TargetLowering::Expand:
      if (ExpandNode(Node))
        return;
      [[fallthrough]];
    case TargetLowering::LibCall:
      ConvertNodeToLibcall(Node);
      return;
    case TargetLowering::Promote:
      PromoteNode(Node);
      return;
    }

  switch (Node->getOpcode()) {
  case ISD::LOAD:
    return LegalizeLoadOps(Node);
  case ISD::STORE:
    return LegalizeStoreOps(Node);
  }
}
```

Look closely to legalize of stop operation, it considered Expand, Custom and Promote.

```cpp
void SelectionDAGLegalize::LegalizeStoreOps(SDNode *Node) {
    SDValue Value = ST->getValue();
    MVT VT = Value.getSimpleValueType();
    switch (TLI.getOperationAction(ISD::STORE, VT)) {
    case TargetLowering::Legal: {
      // If this is an unaligned store and the target doesn't support it, expand it.
      EVT MemVT = ST->getMemoryVT();
      const DataLayout &DL = DAG.getDataLayout();
      if (!TLI.allowsMemoryAccessForAlignment(*DAG.getContext(), DL, MemVT,
                                              *ST->getMemOperand())) {
        SDValue Result = TLI.expandUnalignedStore(ST, DAG);
        ReplaceNode(SDValue(ST, 0), Result);
      }
      break;
    }
    case TargetLowering::Custom: {
      SDValue Res = TLI.LowerOperation(SDValue(Node, 0), DAG);
      if (Res && Res != SDValue(Node, 0))
        ReplaceNode(SDValue(Node, 0), Res);
      return;
    }
    case TargetLowering::Promote: {
      MVT NVT = TLI.getTypeToPromoteTo(ISD::STORE, VT);
      Value = DAG.getNode(ISD::BITCAST, dl, NVT, Value);
      SDValue Result = DAG.getStore(Chain, dl, Value, Ptr, ST->getPointerInfo(),
                                    ST->getOriginalAlign(), MMOFlags, AAInfo);
      ReplaceNode(SDValue(Node, 0), Result);
      break;
    }
    }
```
